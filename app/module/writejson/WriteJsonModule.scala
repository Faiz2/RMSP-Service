package module.writejson

import java.util.UUID

import com.mongodb.DBObject
import com.pharbers.ErrorCode
import com.pharbers.bmmessages.{CommonModules, MessageDefines}
import com.pharbers.bmpattern.ModuleTrait
import com.pharbers.dbManagerTrait.dbInstanceManager
import module.writejson.WriteJsonData._
import module.writejson.WriteJsonMessage._
import play.api.libs.json.{JsValue, Json}
import play.api.libs.json.Json._

object WriteJsonModule extends ModuleTrait with WriteJsonData  with JMap{
	def dispatchMsg(msg: MessageDefines)
				   (pr: Option[String Map JsValue])
				   (implicit cm: CommonModules): (Option[String Map JsValue], Option[JsValue]) = msg match {
		case WriterJsonData(data) => writeJsonWithFile(data)
		case _ => throw new Exception("function is not impl")
	}

	def writeJsonWithFile(data: JsValue)(implicit cm: CommonModules): (Option[String Map JsValue], Option[JsValue]) = {
		try {
//			implicit val func = HandleImpl.j2s
			val connection = cm.modules.get.get("db").map(x => x.asInstanceOf[dbInstanceManager]).getOrElse(throw new Exception("no db connection"))
			val db = connection.queryDBInstance("stp").get
			val uuid = UUID.randomUUID().toString
			val js : DBObject= toJson(Map("fileKey"-> toJson(uuid) , "value" -> data))
			db.insertObject(js , "jsonMsg","fileKey")
//			val s = "{\"phase\":[1],\"p1_total_promotional_budget\":[\"800000\"],\"p1_product1\":[\"1\"],\"p1_arranged_promotional_budget\":[\"1\"],\"p1_product2\":[\"0\"],\"p1_arranged_time_of_sr1\":[\"1\"],\"p1_product3\":[\"0\"],\"p1_arranged_time_of_sr2\":[\"1\"],\"p1_product4\":[\"0\"],\"p1_arranged_time_of_sr3\":[\"1\"],\"p1_arranged_time_of_sr4\":[\"1\"],\"p1_arranged_time_of_sr5\":[\"1\"],\"p1_potential_sales_hosp1_1\":[\"5940,000\"],\"p1_potential_sales_hosp1_2\":[\"1760,000\"],\"p1_potential_sales_hosp1_3\":[\"1628,000\"],\"p1_potential_sales_hosp1_4\":[\"240000\"],\"p1_promotional_budget_hosp1\":[\"0\"],\"p1_current_sales_hosp1_1\":[\"557714\"],\"p1_current_sales_hosp1_2\":[\"194220\"],\"p1_current_sales_hosp1_3\":[\"207356\"],\"p1_current_sales_hosp1_4\":[\"0\"],\"p1_hosp1_sales_target_1\":[\"0\"],\"p1_hosp1_sales_target_2\":[\"0\"],\"p1_hosp1_sales_target_3\":[\"0\"],\"p1_hosp1_sales_target_4\":[\"0\"],\"p1_hosp1_worktime_1\":[\"0\"],\"p1_hosp1_worktime_2\":[\"0\"],\"p1_hosp1_worktime_3\":[\"0\"],\"p1_hosp1_worktime_4\":[\"0\"],\"p1_potential_sales_hosp2_1\":[\"2100,000\"],\"p1_potential_sales_hosp2_2\":[\"1020,000\"],\"p1_potential_sales_hosp2_3\":[\"1188,000\"],\"p1_potential_sales_hosp2_4\":[\"120000\"],\"p1_promotional_budget_hosp2\":[\"01\"],\"p1_current_sales_hosp2_1\":[\"235680\"],\"p1_current_sales_hosp2_2\":[\"116161\"],\"p1_current_sales_hosp2_3\":[\"60832\"],\"p1_current_sales_hosp2_4\":[\"0\"],\"p1_hosp2_sales_target_1\":[\"01\"],\"p1_hosp2_sales_target_2\":[\"0\"],\"p1_hosp2_sales_target_3\":[\"0\"],\"p1_hosp2_sales_target_4\":[\"0\"],\"p1_hosp2_worktime_1\":[\"01\"],\"p1_hosp2_worktime_2\":[\"0\"],\"p1_hosp2_worktime_3\":[\"0\"],\"p1_hosp2_worktime_4\":[\"0\"],\"p1_potential_sales_hosp3_1\":[\"5016,000\"],\"p1_potential_sales_hosp3_3\":[\"924000\"],\"p1_potential_sales_hosp3_4\":[\"1200,000\"],\"p1_promotional_budget_hosp3\":[\"0\"],\"p1_current_sales_hosp3_1\":[\"325492\"],\"p1_current_sales_hosp3_2\":[\"96727\"],\"p1_current_sales_hosp3_3\":[\"77569\"],\"p1_current_sales_hosp3_4\":[\"0\"],\"p1_hosp3_sales_target_1\":[\"0\"],\"p1_hosp3_sales_target_2\":[\"0\"],\"p1_hosp3_sales_target_3\":[\"0\"],\"p1_hosp3_sales_target_4\":[\"0\"],\"p1_hosp3_worktime_1\":[\"01\"],\"p1_hosp3_worktime_2\":[\"0\"],\"p1_hosp3_worktime_3\":[\"0\"],\"p1_hosp3_worktime_4\":[\"0\"],\"p1_potential_sales_hosp4_1\":[\"3300,000\"],\"p1_potential_sales_hosp4_2\":[\"1140,000\"],\"p1_potential_sales_hosp4_3\":[\"680000\"],\"p1_potential_sales_hosp4_4\":[\"132000\"],\"p1_promotional_budget_hosp4\":[\"0\"],\"p1_current_sales_hosp4_1\":[\"612097\"],\"p1_current_sales_hosp4_2\":[\"239623\"],\"p1_current_sales_hosp4_3\":[\"135741\"],\"p1_current_sales_hosp4_4\":[\"0\"],\"p1_hosp4_sales_target_1\":[\"0\"],\"p1_hosp4_sales_target_2\":[\"0\"],\"p1_hosp4_sales_target_3\":[\"0\"],\"p1_hosp4_sales_target_4\":[\"0\"],\"p1_hosp4_worktime_1\":[\"01\"],\"p1_hosp4_worktime_2\":[\"0\"],\"p1_hosp4_worktime_3\":[\"0\"],\"p1_hosp4_worktime_4\":[\"0\"],\"p1_potential_sales_hosp5_1\":[\"800000\"],\"p1_potential_sales_hosp5_2\":[\"618000\"],\"p1_potential_sales_hosp5_3\":[\"730000\"],\"p1_potential_sales_hosp5_4\":[\"66000\"],\"p1_promotional_budget_hosp5\":[\"0\"],\"p1_current_sales_hosp5_1\":[\"39174\"],\"p1_current_sales_hosp5_2\":[\"84037\"],\"p1_current_sales_hosp5_3\":[\"30838\"],\"p1_current_sales_hosp5_4\":[\"0\"],\"p1_hosp5_sales_target_1\":[\"0\"],\"p1_hosp5_sales_target_2\":[\"0\"],\"p1_hosp5_sales_target_3\":[\"0\"],\"p1_hosp5_sales_target_4\":[\"0\"],\"p1_hosp5_worktime_1\":[\"01\"],\"p1_hosp5_worktime_2\":[\"0\"],\"p1_hosp5_worktime_3\":[\"0\"],\"p1_hosp5_worktime_4\":[\"0\"],\"p1_potential_sales_hosp6_1\":[\"3500,000\"],\"p1_potential_sales_hosp7_2\":[\"802500\"],\"p1_potential_sales_hosp6_4\":[\"0\"],\"p1_promotional_budget_hosp6\":[\"0\"],\"p1_current_sales_hosp6_1\":[\"359538\"],\"p1_current_sales_hosp6_2\":[\"71578\"],\"p1_current_sales_hosp6_3\":[\"38684\"],\"p1_current_sales_hosp6_4\":[\"0\"],\"p1_hosp6_sales_target_1\":[\"0\"],\"p1_hosp6_sales_target_2\":[\"0\"],\"p1_hosp6_sales_target_3\":[\"0\"],\"p1_hosp6_sales_target_4\":[\"0\"],\"p1_hosp6_worktime_1\":[\"01\"],\"p1_hosp6_worktime_2\":[\"0\"],\"p1_hosp6_worktime_3\":[\"0\"],\"p1_hosp6_worktime_4\":[\"0\"],\"p1_potential_sales_hosp7_3\":[\"370800\"],\"p1_potential_sales_hosp7_4\":[\"0\"],\"p1_promotional_budget_hosp7\":[\"0\"],\"p1_current_sales_hosp7_1\":[\"108464\"],\"p1_current_sales_hosp7_2\":[\"97941\"],\"p1_current_sales_hosp7_3\":[\"56574\"],\"p1_current_sales_hosp7_4\":[\"0\"],\"p1_hosp7_sales_target_1\":[\"0\"],\"p1_hosp7_sales_target_2\":[\"0\"],\"p1_hosp7_sales_target_3\":[\"0\"],\"p1_hosp7_sales_target_4\":[\"0\"],\"p1_hosp7_worktime_1\":[\"0\"],\"p1_hosp7_worktime_2\":[\"0\"],\"p1_hosp7_worktime_3\":[\"0\"],\"p1_hosp7_worktime_4\":[\"0\"],\"p1_potential_sales_hosp8_1\":[\"483000\"],\"p1_potential_sales_hosp8_2\":[\"432000\"],\"p1_potential_sales_hosp8_3\":[\"120000\"],\"p1_potential_sales_hosp8_4\":[\"435000\"],\"p1_promotional_budget_hosp8\":[\"0\"],\"p1_current_sales_hosp8_1\":[\"31748\"],\"p1_current_sales_hosp8_2\":[\"83664\"],\"p1_current_sales_hosp8_3\":[\"17264\"],\"p1_current_sales_hosp8_4\":[\"0\"],\"p1_hosp8_sales_target_1\":[\"0\"],\"p1_hosp8_sales_target_2\":[\"0\"],\"p1_hosp8_sales_target_3\":[\"0\"],\"p1_hosp8_sales_target_4\":[\"0\"],\"p1_hosp8_worktime_1\":[\"0\"],\"p1_hosp8_worktime_2\":[\"0\"],\"p1_hosp8_worktime_3\":[\"0\"],\"p1_hosp8_worktime_4\":[\"0\"],\"p1_potential_sales_hosp9_1\":[\"362000\"],\"p1_potential_sales_hosp9_2\":[\"399000\"],\"p1_potential_sales_hosp9_3\":[\"49000\"],\"p1_potential_sales_hosp9_4\":[\"0\"],\"p1_promotional_budget_hosp9\":[\"0\"],\"p1_current_sales_hosp9_1\":[\"27327\"],\"p1_current_sales_hosp9_2\":[\"67351\"],\"p1_current_sales_hosp9_3\":[\"9786\"],\"p1_current_sales_hosp9_4\":[\"0\"],\"p1_hosp9_sales_target_1\":[\"0\"],\"p1_hosp9_sales_target_2\":[\"0\"],\"p1_hosp9_sales_target_3\":[\"0\"],\"p1_hosp9_sales_target_4\":[\"0\"],\"p1_hosp9_worktime_1\":[\"0\"],\"p1_hosp9_worktime_2\":[\"0\"],\"p1_hosp9_worktime_3\":[\"0\"],\"p1_hosp9_worktime_4\":[\"0\"],\"p1_potential_sales_hosp10_1\":[\"7031,200\"],\"p1_potential_sales_hosp10_2\":[\"1860,100\"],\"p1_potential_sales_hosp10_3\":[\"1980,000\"],\"p1_potential_sales_hosp10_4\":[\"300000\"],\"p1_promotional_budget_hosp10\":[\"0\"],\"p1_current_sales_hosp10_1\":[\"940855\"],\"p1_current_sales_hosp10_2\":[\"355266\"],\"p1_current_sales_hosp10_3\":[\"341064\"],\"p1_current_sales_hosp10_4\":[\"0\"],\"p1_hosp10_sales_target_1\":[\"0\"],\"p1_hosp10_sales_target_2\":[\"0\"],\"p1_hosp10_sales_target_3\":[\"0\"],\"p1_hosp10_sales_target_4\":[\"0\"],\"p1_hosp10_worktime_1\":[\"0\"],\"p1_hosp10_worktime_2\":[\"0\"],\"p1_hosp10_worktime_3\":[\"0\"],\"p1_hosp10_worktime_4\":[\"0\"],\"p1_sr_hosp1\":[\"\"],\"p1_sr_hosp2\":[\"??\"],\"p1_sr_hosp3\":[\"??\"],\"p1_sr_hosp4\":[\"??\"],\"p1_sr_hosp5\":[\"??\"],\"p1_sr_hosp6\":[\"??\"],\"p1_sr_hosp7\":[\"\"],\"p1_sr_hosp8\":[\"\"],\"p1_sr_hosp9\":[\"\"],\"p1_sr_hosp10\":[\"\"],\"user_name\":[\"banana\"],\"p1_work_time\":[\"100\"],\"p1_arranged_time_of_flm\":[\"0\"],\"p1_total_sales_training\":[\"0\"],\"p1_flm_sales_training\":[\"0\"],\"p1_sr1_sales_training\":[\"0\"],\"p1_sr2_sales_training\":[\"0\"],\"p1_sr3_sales_training\":[\"0\"],\"p1_sr4_sales_training\":[\"0\"],\"p1_sr5_sales_training\":[\"0\"],\"p1_total_field_work\":[\"0\"],\"p1_flm_field_work\":[\"0\"],\"p1_sr1_field_work\":[\"0\"],\"p1_sr2_field_work\":[\"0\"],\"p1_sr3_field_work\":[\"0\"],\"p1_sr4_field_work\":[\"0\"],\"p1_sr5_field_work\":[\"0\"],\"p1_total_team_meeting\":[\"0\"],\"p1_flm_team_meeting\":[\"0\"],\"p1_sr1_team_meeting\":[\"0\"],\"p1_sr2_team_meeting\":[\"0\"],\"p1_sr3_team_meeting\":[\"0\"],\"p1_sr4_team_meeting\":[\"0\"],\"p1_sr5_team_meeting\":[\"0\"],\"p1_total_kpi_analysis\":[\"0\"],\"p1_flm_kpi_analysis\":[\"0\"],\"p1_total_admin_work\":[\"0\"],\"p1_flm_admin_work\":[\"0\"],\"p1_total_management\":[\"0\"],\"p1_flm_management\":[\"0\"],\"p1_sr1_product_training\":[\"0\"],\"p1_sr2_product_training\":[\"0\"],\"p1_sr3_product_training\":[\"0\"],\"p1_sr4_product_training\":[\"0\"],\"p1_sr5_product_training\":[\"0\"]}"
//			val d = Json.parse(s)
//			println(s)
			val reportFileName = s"${UUID.randomUUID().toString}.xlsx"
//			(Some(Map("data" -> toJson(Map("flag" -> toJson(true), "jsonfilename" -> toJson(wirteJson(data)), "reportfilename" -> toJson(reportFileName) )))), None)
			(Some(Map("data" -> toJson(Map("flag" -> toJson(true), "jsonfilename" -> toJson(data), "reportfilename" -> toJson(reportFileName) )))), None)
		} catch {
			case ex: Exception => (None, Some(ErrorCode.errorToJson(ex.getMessage)))
		}
	}
}
